##########################
These are all the home battery related automations not currently in use
##########################

alias: Get desired battery %
description: Send a notification asking for desired battery percentage
trigger:
  - platform: time
    at: "22:00:00"
condition: []
action:
  - alias: Send notification
    service: notify.mobile_app_pixel_5
    data:
      message: >
        What battery % do you want to charge to? (default {{
        states('input_number.default_battery_percentage')|int }}%)

        Estimated Production Tomorrow: {{
        states('sensor.energy_production_tomorrow') }}kWh

        Estimated Peak Power At: {{
        as_timestamp(states('sensor.power_highest_peak_time_tomorrow')) |
        timestamp_custom("%H:%M", local=True, default="ERROR") }}
      title: Set battery charge %
      data:
        actions:
          - action: NINETY
            title: 90%
          - action: EIGHTY
            title: 80%
          - action: REPLY
            title: Custom
  - alias: Wait for a response
    wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: NINETY
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: REPLY
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: EIGHTY
    timeout:
      hours: 1
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: true
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ not wait.trigger }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.desired_battery_percentage
            data:
              value: "{{ states('input_number.default_battery_percentage') | float }}"
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == \"NINETY\" }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.desired_battery_percentage
            data:
              value: 90
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == \"REPLY\" }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.desired_battery_percentage
            data:
              value: |
                {{ wait.trigger.event.data.reply_text | int(0) }}
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == \"EIGHTY\" }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.desired_battery_percentage
            data:
              value: 80
mode: single

alias: Discharge Battery to Desired %
description: Discharge the Home Battery to the desired % during Flux peak time
trigger:
  - platform: state
    entity_id:
      - sensor.solaredge_b1_state_of_energy
    enabled: true
    id: Battery State of Energy
  - platform: time
    id: Start of peak
    alias: At Start Discharge Helper Time
    at: input_datetime.start_battery_discharge
  - platform: time
    at: input_datetime.end_battery_discharge
    id: End of peak
    alias: At End Discharge Helper Time
  - platform: state
    entity_id:
      - switch.solaredge_i1_advanced_power_control
    from: unavailable
    to: "on"
    id: Inverter Reset
condition:
  - condition: state
    entity_id: input_boolean.allow_battery_grid_discharge
    state: "on"
action:
  - choose:
      - conditions:
          - condition: trigger
            id: Start of peak
          - condition: numeric_state
            entity_id: sensor.solaredge_b1_state_of_energy
            above: input_number.desired_battery_discharge_percentage
            alias: Confirm Battery State of Charge is above desired discharge %
        sequence:
          - service: number.set_value
            data:
              value: >-
                {{
                states('input_number.storage_command_timeout_for_discharge_to_grid')
                | float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_command_timeout
            alias: Set Storage Command Timeout to Input Number Helper Value
          - service: number.set_value
            data:
              value: "{{ states('input_number.battery_output_limit') | float(0) }}"
            target:
              entity_id: number.solaredge_i1_storage_discharge_limit
            alias: Set Storage Discharge Limit to Input Number Helper Value
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: select_option
            option: Discharge to Maximize Export
            alias: Set Storage Command Mode to Discharge to Maximise Export
      - conditions:
          - condition: trigger
            id: Battery State of Energy
          - condition: device
            device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: selected_option
            option: Discharge to Maximize Export
            alias: Storage Command Mode is Discharge to Maximise Export
          - condition: numeric_state
            entity_id: sensor.solaredge_b1_state_of_energy
            below: input_number.desired_battery_discharge_percentage
        sequence:
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.storage_command_timeout_default_period')
                | float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_command_timeout
            alias: Set Storage Command Timeout to Default Value
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: select_option
            option: Maximize Self Consumption
            alias: Set Storage Command Mode to MSC
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.default_battery_output_limit') |
                float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_discharge_limit
            alias: Set Storage Discharge Limit to Input Number Helper Value
      - conditions:
          - condition: trigger
            id: End of peak
          - condition: not
            conditions:
              - condition: device
                device_id: 952193e87f675ba7f7e32eda5500c572
                domain: select
                entity_id: select.solaredge_i1_storage_command_mode
                type: selected_option
                option: Maximize Self Consumption
            alias: Test if Storage Command Mode is MSC
        sequence:
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.storage_command_timeout_default_period')
                | float (0) }}
            target:
              entity_id: number.solaredge_i1_storage_command_timeout
            alias: Set Storage Command Timeout to Default Value
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: select_option
            option: Maximize Self Consumption
            alias: Set Storage Command Mode to MSC
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.default_battery_output_limit') |
                float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_discharge_limit
            alias: Set Storage Discharge Limit to Input Number Helper Value
mode: single

alias: "Grid Charge Battery to Desired % "
description: Charge the Home Battery to the desired % from the grid during off-peak time
trigger:
  - platform: state
    entity_id:
      - sensor.solaredge_b1_state_of_energy
    enabled: true
    id: Battery State of Energy
  - platform: time
    at: input_datetime.start_battery_grid_charge
    id: Start of off peak
    alias: When off-peak period has started
  - platform: time
    at: input_datetime.end_battery_grid_charge
    id: End of off peak
    alias: When off-peak period has ended
condition: []
action:
  - choose:
      - conditions:
          - condition: trigger
            id: Start of off peak
          - condition: numeric_state
            entity_id: sensor.solaredge_b1_state_of_energy
            below: input_number.desired_battery_percentage
        sequence:
          - service: script.grid_charge_battery
            data: {}
      - conditions:
          - condition: trigger
            id: Battery State of Energy
          - condition: device
            device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: selected_option
            option: Charge from Solar Power and Grid
            alias: Storage Command Mode is Charge from Solar Power and Grid
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: sensor.solaredge_b1_state_of_energy
                above: input_number.desired_battery_percentage
              - condition: numeric_state
                entity_id: sensor.solaredge_b1_state_of_energy
                above: 99.5
        sequence:
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.storage_command_timeout_default_period')
                | float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_command_timeout
            alias: Set Storage Command Timeout to Default Value
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: select_option
            option: Maximize Self Consumption
            alias: Set Storage Command Mode to MSC
          - service: input_number.set_value
            data:
              value: 0
            target:
              entity_id: input_number.desired_battery_percentage
            alias: Set Desired Battery % to zero
      - conditions:
          - condition: trigger
            id: End of off peak
          - condition: not
            conditions:
              - condition: device
                device_id: 952193e87f675ba7f7e32eda5500c572
                domain: select
                entity_id: select.solaredge_i1_storage_command_mode
                type: selected_option
                option: Maximize Self Consumption
            alias: Test if Storage Command Mode is MSC
        sequence:
          - service: number.set_value
            data:
              value: >-
                {{ states('input_number.storage_command_timeout_default_period')
                | float(0) }}
            target:
              entity_id: number.solaredge_i1_storage_command_timeout
            alias: Set Storage Command Timeout to Default Value
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: select.solaredge_i1_storage_command_mode
            type: select_option
            option: Maximize Self Consumption
            alias: Set Storage Command Mode to MSC
mode: single

alias: Grid Charge Battery to full
description: ""
trigger:
  - platform: time
    at: input_datetime.start_battery_grid_charge
    id: Start of slot 1
  - platform: time
    at: input_datetime.end_battery_grid_charge
    id: End of slot 1
  - platform: time
    at: input_datetime.start_battery_grid_charge_slot_2_at
    id: Start of slot 2
  - platform: time
    at: input_datetime.end_battery_charge_grid_slot_2_at
    id: End of slot 2
  - platform: time
    at: input_datetime.start_battery_grid_charge_slot_3_at
    id: Start of slot 3
  - platform: time
    at: input_datetime.end_battery_charge_grid_slot_3_at
    id: End of slot 3
  - platform: time
    at: input_datetime.start_battery_grid_charge_slot_4_at
    id: Start of slot 4
  - platform: time
    at: input_datetime.end_battery_grid_charge_slot_4_at
    id: End of slot 4
  - platform: state
    entity_id:
      - switch.solaredge_i1_grid_control
      - switch.solaredge_i1_advanced_power_control
    from: unavailable
    to: "on"
    id: Inverter Reset
condition: []
action:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - Start of slot 1
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_1_active
            state: "on"
        sequence:
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
          - service: script.grid_charge_battery
            data: {}
      - conditions:
          - condition: trigger
            id:
              - End of slot 1
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_1_active
            state: "on"
        sequence:
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: 0bdfb19491b49722c2a94351b9a673aa
            type: select_option
            option: Maximize Self Consumption
          - service: input_boolean.turn_off
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
      - conditions:
          - condition: trigger
            id:
              - Start of slot 2
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_2_active
            state: "on"
        sequence:
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
          - service: script.grid_charge_battery
            data: {}
      - conditions:
          - condition: trigger
            id:
              - End of slot 2
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_2_active
            state: "on"
        sequence:
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: 0bdfb19491b49722c2a94351b9a673aa
            type: select_option
            option: Maximize Self Consumption
          - service: input_boolean.turn_off
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
      - conditions:
          - condition: trigger
            id:
              - Start of slot 3
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_3_active
            state: "on"
        sequence:
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
          - service: script.grid_charge_battery
            data: {}
      - conditions:
          - condition: trigger
            id:
              - End of slot 3
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_3_active
            state: "on"
        sequence:
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: 0bdfb19491b49722c2a94351b9a673aa
            type: select_option
            option: Maximize Self Consumption
          - service: input_boolean.turn_off
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
      - conditions:
          - condition: trigger
            id:
              - Start of slot 4
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_4_active
            state: "on"
        sequence:
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
          - service: script.grid_charge_battery
            data: {}
      - conditions:
          - condition: trigger
            id:
              - End of slot 4
          - condition: state
            entity_id: input_boolean.grid_charge_battery_slot_4_active
            state: "on"
        sequence:
          - device_id: 952193e87f675ba7f7e32eda5500c572
            domain: select
            entity_id: 0bdfb19491b49722c2a94351b9a673aa
            type: select_option
            option: Maximize Self Consumption
          - service: input_boolean.turn_off
            data: {}
            target:
              entity_id: input_boolean.home_battery_grid_charging
      - conditions:
          - condition: trigger
            id:
              - Inverter Reset
          - condition: state
            entity_id: input_boolean.grid_charge_home_battery
            state: "on"
          - condition: or
            conditions:
              - condition: time
                after: input_datetime.start_battery_grid_charge
                before: input_datetime.end_battery_grid_charge
              - condition: time
                after: input_datetime.start_battery_grid_charge_slot_2_at
                before: input_datetime.end_battery_charge_grid_slot_2_at
              - condition: time
                after: input_datetime.start_battery_grid_charge_slot_3_at
                before: input_datetime.end_battery_charge_grid_slot_3_at
              - condition: time
                after: input_datetime.start_battery_grid_charge_slot_4_at
                before: input_datetime.end_battery_grid_charge_slot_4_at
        sequence:
          - service: script.grid_charge_battery
            data: {}
mode: restart


alias: Set battery to charge from clipped Solar ( normally after longer EV charge)
description: ""
trigger:
  - platform: time
    at: input_datetime.start_charge_from_clipped_solar
condition: []
action:
  - service: number.set_value
    data:
      value: >-
        {{
        states('input_number.storage_command_timeout_period_for_clipped_solar')
        | float(0)}}
    target:
      entity_id: number.solaredge_i1_storage_command_timeout
    alias: Set Storage Command Timeout to Clipped Solar Input Number Helper
  - device_id: 952193e87f675ba7f7e32eda5500c572
    domain: select
    entity_id: select.solaredge_i1_storage_command_mode
    type: select_option
    option: Charge from Clipped Solar Power
    alias: Set Storage Command Mode to Charge from Clipped Solar
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  - service: number.set_value
    data:
      value: >-
        {{ states('input_number.storage_command_timeout_default_period') |
        float(0)}}
    target:
      entity_id: number.solaredge_i1_storage_command_timeout
    alias: Set Storage Command Timeout to default
mode: single

alias: Charging Controls Work Together
description: ""
trigger:
  - platform: state
    entity_id:
      - input_boolean.grid_charge_battery_slot_1_active
      - input_boolean.grid_charge_battery_slot_2_active
      - input_boolean.grid_charge_battery_slot_3_active
      - input_boolean.grid_charge_battery_slot_4_active
    id: Grid Slot Active Change
  - platform: state
    entity_id:
      - input_datetime.start_battery_grid_charge
      - input_datetime.start_battery_grid_charge_slot_2_at
      - input_datetime.start_battery_grid_charge_slot_3_at
      - input_datetime.start_battery_output_limit_slot_4
    id: Grid Slot Start Time Set
  - platform: state
    entity_id:
      - input_datetime.end_battery_grid_charge
      - input_datetime.end_battery_charge_grid_slot_2_at
      - input_datetime.end_battery_charge_grid_slot_3_at
      - input_datetime.end_battery_grid_charge_slot_4_at
    id: Grid Slot End Time Set
condition: []
action:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Active Change
          - condition: template
            value_template: "{{ \"1\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_boolean.toggle
            data: {}
            target:
              entity_id:
                - input_boolean.rolec_slot_1_active
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Active Change
          - condition: template
            value_template: "{{ \"2\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_boolean.toggle
            data: {}
            target:
              entity_id:
                - input_boolean.rolec_slot_2_active
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Active Change
          - condition: template
            value_template: "{{ \"3\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_boolean.toggle
            data: {}
            target:
              entity_id:
                - input_boolean.rolec_slot_3_active
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Active Change
          - condition: template
            value_template: "{{ \"4\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_boolean.toggle
            data: {}
            target:
              entity_id:
                - input_boolean.rolec_slot_4_active
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Start Time Set
          - condition: template
            value_template: "{{ \"1\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: "{{ states('input_datetime.start_battery_grid_charge') }}"
            target:
              entity_id:
                - input_datetime.rolec_wallbox_on
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.start_battery_grid_charge'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.start_battery_grid_charge_slot_2_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Start Time Set
          - condition: template
            value_template: "{{ \"2\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: >-
                {{ states('input_datetime.start_battery_grid_charge_slot_2_at')
                }}
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_2_on_at
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.start_battery_grid_charge_slot_2_at'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.start_battery_grid_charge_slot_3_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Start Time Set
          - condition: template
            value_template: "{{ \"3\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: >-
                {{ states('input_datetime.start_battery_grid_charge_slot_3_at')
                }}
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_3_on_at
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.start_battery_grid_charge_slot_3_at'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.start_battery_grid_charge_slot_4_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot Start Time Set
          - condition: template
            value_template: "{{ \"4\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: >-
                {{ states('input_datetime.start_battery_grid_charge_slot_4_at')
                }}
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_4_on_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot End Time Set
          - condition: template
            value_template: "{{ \"1\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: "{{ states('input_datetime.end_battery_grid_charge') }}"
            target:
              entity_id:
                - input_datetime.rolec_wallbox_off
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.end_battery_grid_charge'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.end_battery_charge_grid_slot_2_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot End Time Set
          - condition: template
            value_template: "{{ \"2\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: "{{ states('input_datetime.end_battery_charge_grid_slot_2_at') }}"
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_2_off_at
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.end_battery_charge_grid_slot_2_at'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.end_battery_charge_grid_slot_3_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot End Time Set
          - condition: template
            value_template: "{{ \"3\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: "{{ states('input_datetime.end_battery_charge_grid_slot_3_at') }}"
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_3_off_at
          - service: input_datetime.set_datetime
            data:
              time: >
                {{(as_timestamp(strptime(states('input_datetime.end_battery_charge_grid_slot_3_at'),
                "%H:%M:%S")) + 1800)|timestamp_custom ("%H:%M")}}
            target:
              entity_id: input_datetime.end_battery_grid_charge_slot_4_at
      - conditions:
          - condition: trigger
            id:
              - Grid Slot End Time Set
          - condition: template
            value_template: "{{ \"4\" in trigger.to_state.attributes.friendly_name }}"
        sequence:
          - service: input_datetime.set_datetime
            data:
              time: "{{ states('input_datetime.end_battery_grid_charge_slot_4_at') }}"
            target:
              entity_id:
                - input_datetime.rolec_wallbox_slot_4_off_at
mode: queued
max: 6

