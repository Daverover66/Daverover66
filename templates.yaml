############################################################ 
#   @author         :   Dave Forrester                     #
#   @date           :   17/08/2023                         #
#   @automation     :   template sensors                   #
#   @description    :   not in a package file              #
#                                                          #
#                                                          #
#   @version        :   1.0                                #
#   @modified       :                                      #
############################################################


- binary_sensor:
  - name: "Daves Samsung Galaxy Home"
    unique_id: daves_samsung_galaxy_home
    state: >
      {{ states('sensor.daves_samsung_galaxy_wifi_connection') == "ForresterQ5G" or states('sensor.daves_samsung_galaxy_wifi_connection') == "ForresterQ"}}

- binary_sensor:
  - name: "Gems Samsung Galaxy Home"
    unique_id: gems_samsung_galaxy_home
    state: >
      {{ states('sensor.sm_s901b_wifi_connection') == "ForresterQ5G" or states('sensor.sm_s901b_wifi_connection') == "ForresterQ" }}

- binary_sensor:
  - name: "Seans Samsung Tablet Home"
    unique_id: seans_samsung_galaxy_home
    state: >
      {{ states('sensor.sean_s_samsung_galaxy_wifi_connection') == "ForresterQ5G" or states('sensor.sean_s_samsung_galaxy_wifi_connection') == "ForresterQ"}}

- binary_sensor:
  - name: "Jamies Samsung Tablet Home"
    unique_id: jamies_samsung_galaxy_home
    state: >
      {{ states('sensor.jamie_s_samsung_tablet_wifi_connection') == "ForresterQ5G" or states('sensor.jamie_s_samsung_tablet_wifi_connection') == "ForresterQ"}}

- binary_sensor: 
  - name: "Dave Home"
    unique_id: dave_home 
    state: >-
      {{ is_state('device_tracker.daves_samsung_galaxy', 'home') or is_state('device_tracker.dmforrester_davessamsunggalaxys23', 'home') or is_state('binary_sensor.daves_samsung_galaxy_home','on')}}

- binary_sensor: 
  - name: "Gem Home"
    unique_id: gem_home 
    state: >- 
      {{ is_state('device_tracker.sm_s901b', 'home') or is_state('binary_sensor.gems_samsung_galaxy_home','on')  }} 
      
- binary_sensor: 
  - name: "Family Home"
    unique_id: family_home 
    state: >- 
      {{ is_state('binary_sensor.gem_home','on') or is_state('binary_sensor.dave_home','on')}}
        

- sensor:
  ##### Low Battery List ######
  - name: "Low Battery Devices"
    unique_id: low_battery_devices_list
    icon: mdi:battery-low
    state: >
      {% set threshold = states('input_number.battery_threshold') | int%}
      {%- set ns = namespace(sensors=[]) -%}
      {%- for state in states.sensor
        | selectattr('attributes.device_class','defined')
        | selectattr('attributes.state_class','defined')
        | selectattr('attributes.device_class','==','battery')
        | selectattr('attributes.state_class','==','measurement')
        | selectattr('state','is_number') -%}
        {%- if state.state | int <= threshold -%}
          {% set ns.sensors = ns.sensors + [dict(name = state.name | replace(' battery', '') | replace(' Battery', ''), state = state.state | int)]%}
        {%- endif -%}
      {%- endfor -%}
      {%- set batt = ns.sensors | sort(attribute = 'state') %}
      {%- set ns = namespace(batt = '')-%}
      {%- for state in batt -%}
          {% set ns.batt = ns.batt + (state.name ~ ' (' ~ state.state ~'%)' ~ "\n")%}
      {%- endfor -%}

      {% if ns.batt | count > 0 %}
        {{ ns.batt | truncate(255, true, '...') }}
      {% else %}
        {{ 'unavailable' }}
      {% endif %}    

- sensor:
  ##### day of week #####
  - name: "Day of Week"
    unique_id: day_of_week
    state: >
      {{ as_timestamp(states('sensor.date_time_iso')) | timestamp_custom('%A') }}


- sensor:
  #### Lights On Counter ######
  - name: "Lights On Count"
    unique_id: lights_on_count
    state: >
      {{ states.light
          | rejectattr('attributes.friendly_name','eq','Valkyrie Backlight')
          | rejectattr('attributes.friendly_name','eq','Upstairs Landing Lights')
          | rejectattr('attributes.friendly_name','eq','Kitchen Light 1')
          | rejectattr('attributes.friendly_name','eq','Kitchen Light 2')
          | rejectattr('attributes.friendly_name','eq','Kitchen Light 3')
          | rejectattr('attributes.friendly_name','eq','Kitchen Light 4')
          | rejectattr('attributes.friendly_name','eq','Kitchen Light 5')
          | rejectattr('attributes.friendly_name','eq','Living Room Light 1')
          | rejectattr('attributes.friendly_name','eq','Living Room Light 2')
          | rejectattr('attributes.friendly_name','eq','Living Room Light 3')
          | rejectattr('attributes.friendly_name','eq','Living Room Light 4')
          | rejectattr('attributes.friendly_name','eq','Living Room Light 5')
          | rejectattr('attributes.entity_id','defined')
          | selectattr('state', 'eq', 'on')
          | list | count }}


- sensor:
  ### Garage Dehumidifier Water Tray Status ###
  - name: "Garage Dehumidifier Water Tray Status"
    unique_id: garage_dehumidifier_water_tray_status
    state: >
      {{ state_attr('humidifier.garage_dehumidifier_2' , 'unknown_11') }}

- sensor:
  ### Garage Dehumidifier Water Tray Full ###
  - name: "Garage Dehumidifier Water Tray Full"
    unique_id: garage_dehumidifier_water_tray_full
    state: >
      {% if states('sensor.garage_dehumidifier_water_tray_status') == "2" %}
        {{"full"}}
      {% else %}
        {{"not_full"}}
      {% endif %}
    availability: >
      {{ states('sensor.garage_dehumidifier_water_tray_status') == "0" 
        or states('sensor.garage_dehumidifier_water_tray_status') == "2" }}

- sensor:
  ### Last Alexa Called ###
  - name: "Last Alexa Called"
    unique_id: last_alexa_called
    state: |-
      {% set last_called = (expand(integration_entities('alexa_media') | select('search', 'media_player'))
      | selectattr('attributes.last_called', 'eq', True) | map(attribute='entity_id') | first )%}
      {% if last_called == "media_player.dave_s_2nd_echo_pop" %}
      Living Room
      {% elif last_called == "media_player.dave_s_echo_pop" %}
      Dining Room
      {% elif last_called == "media_player.guest_bedroom_echo_dot" %}
      Guest Bedroom
      {% elif last_called == "media_player.kitchen_echo_show" %}
      Kitchen
      {% elif last_called == "media_player.living_room_dot" %}
      Jamie's Room
      {% elif last_called == "media_player.main_bedroom_dot" %}
      Main Bedroom
      {% elif last_called == "media_player.seans_room_dot" %}
      Sean's Room
      {% endif %}
    availability: |-
      {{ states.media_player | rejectattr('object_id','match', '(sky_q|toshiba)')
      | selectattr('attributes.last_called','eq',True) | map(attribute='entity_id')
      | first is defined}}
      

      

- sensor:
  ### Room Presence for Alexa ###
  - name: "Room Presence For Alexa"
    unique_id: room_presence_for_alexa
    state: |-
      {% set room_presence = (expand('group.room_with_alexa_presence') | selectattr('state','eq','on') | map(attribute='name')) | list %}
      {% if "living_room" in room_presence %}
        Living Room
      {% elif "kitchen" in room_presence %}
        Kitchen
      {% elif "dining_room" in room_presence %}
        Dining Room
      {% elif "main_bedroom" in room_presence %}
        Main Bedroom
      {% elif "guest_bedroom" in room_presence %}
        Guest Bedroom
      {% elif "Jamie" in room_presence %}
        Jamies Room
      {% elif "Sean" in room_presence %}
        Seans Room
      {% else %}
        Living Room
      {% endif %}


- sensor:
  ### determine overnight low temperature for daily briefing ###
  - name: "Overnight Low Temp"
    unique_id: overnight_temp_low
    state: |-
      {% set start = now().replace(hour=0,minute=0,second=0, microsecond=0) %}
      {% set end = (start + timedelta(days=1)) %}
      {% set start = start.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
      {% set end = end.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
        {{ state_attr('weather.openweathermap', 'forecast') | selectattr('datetime', '>=', start) | selectattr('datetime','<=', end) | map(attribute='temperature') | list | min }}

- sensor:
  ### determine overnight high temperature for daily briefing ###
  - name: "Overnight High Temp"
    unique_id: overnight_temp_high
    state: |-
      {% set start = now().replace(hour=0,minute=0,second=0, microsecond=0) %}
      {% set end = (start + timedelta(days=1)) %}
      {% set start = start.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
      {% set end = end.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
        {{ state_attr('weather.openweathermap', 'forecast') | selectattr('datetime', '>=', start) | selectattr('datetime','<=', end) | map(attribute='temperature') | list | max }}


  ### Trigger based sensor to store calendar events ###
- trigger:
  - platform: event
    event_type: calendar_poll
  sensor:
    - name: "Calendar Events"
      unique_id: calendar_events
      state: "{{ trigger.event.data.calendar_response.events | count() }}"
      attributes:
        calendar_response: "{{ trigger.event.data.calendar_response }}"
      icon: mdi:calendar


- sensor:
  ### another location based sensor ###
  - name: "Dave is in da hoose"
    unique_id: dave_is_in_da_hoose
    state: |-
      {% set dave_location = states('binary_sensor.daves_samsung_galaxy_home')%}
      {% if dave_location == "on" %}
        home
      {% else %}
      not_home
      {% endif %}

- sensor:
  ### yet another location based sensor ###
  - name: "Gem is in da hoose"
    unique_id: gem_is_in_da_hoose
    state: |-
      {% set gem_location = states('binary_sensor.gems_samsung_galaxy_home')%}
      {% if gem_location == "on" %}
        home
      {% else %}
      not_home
      {% endif %}

######################################
#      Action Template Sensor        #
######################################

- trigger:
  - platform: time_pattern
    hours: /1
  action: 
    - service: weather.get_forecasts 
      target: 
        entity_id: weather.openweathermap
      data: 
        type: hourly
      response_variable: my_forecast
  sensor:
    - name: Weather Total Expected Rainfall 24 Hours
      unique_id: weather_total_expected_rainfall_24_hrs
      icon: mdi:weather-pouring
      unit_of_measurement: mm
      state: >
        {% set ns = namespace() %}
        {% set ns.totalrainfall = 0 %}
        {% for daypart in range(0,7) %}
          {% set rainfall = my_forecast["weather.openweathermap"].forecast[daypart].precipitation %}
          {% set rainfall_probability = my_forecast["weather.openweathermap"].forecast[daypart].precipitation_probability / 100 %}
          {% if rainfall_probability > 0 %}
            {% set rainfall = rainfall * rainfall_probability %}
          {% endif %}
          {% set ns.totalrainfall = ns.totalrainfall + rainfall %}
        {% endfor %}
        {{ ns.totalrainfall | float(0) | round(2) }}

################################
#    More Days until sensors   #
################################

- sensor:
  - name: "Days Until Mum's Birthday"
    unique_id: days_until_mums_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=9, day=24)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=9, day=24))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=9, day=24)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Dad's Birthday"
    unique_id: days_until_dads_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=9, day=30)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=9, day=30))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=9 day=30)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Sean's Birthday"
    unique_id: days_until_seans_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=3, day=22)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=3, day=22))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=3, day=22)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Jamie's Birthday"
    unique_id: days_until_jamies_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=1, day=7)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=1, day=7))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=1, day=7)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Gregor's Birthday"
    unique_id: days_until_gregors_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=3, day=15)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=3, day=15))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=3, day=15)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Blair's Birthday"
    unique_id: days_until_blairs_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=11, day=9)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=11, day=9))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=11, day=9)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Grandad's Birthday"
    unique_id: days_until_grandads_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=5, day=13)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=5, day=13))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=5, day=13)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Grandma's Birthday"
    unique_id: days_until_grandmas_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=1, day=15)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=1, day=15))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=1, day=15)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Dada's Birthday"
    unique_id: days_until_dadas_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=9, day=11)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=9, day=11))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=9, day=11)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: "Days Until Nannie's Birthday"
    unique_id: days_until_nannies_birthday
    unit_of_measurement: Days
    state: >
      {% set daystogo = ((as_timestamp(now().replace(month=7, day=22)) - as_timestamp(now()) | int) / 86400) | round(0) %}
      {% if daystogo < 0 %}
        {{ 365 - ((as_timestamp(now()) | int - as_timestamp(now().replace(month=7, day=22))) / 86400) | round(0)}}
      {% else %}
        {{ ((as_timestamp(now().replace(month=7, day=22)) - as_timestamp(now()) | int) / 86400) | round(0) }}
      {% endif %}

- sensor:
  - name: xxxxxx
    unique_id: xxxxxx
    state: >
      {% set start_time = states('octopusagile.electric_vehicle') %}
       # {{ (as_timestamp(start_time|as_datetime)) | timestamp_custom ('%H:%M %p')}}
      {% set now = as_timestamp(now()) %}
      {% set active =  (as_timestamp(start_time)|int) - (now|int) %}
       # {{ active }}
      {% if active <= 0 %}
        Active
      {% else %}
        Waiting
      {% endif %}

### Battery Charge Times ### 
- sensor:
  - name: "Home Battery Charge Start Time"
    unique_id: home_battery_charge_start_time
    icon: mdi:clock-start
    state: >
      {% set start_time = states('octopusagile.home_battery') %}
        {{ as_timestamp(start_time)|timestamp_custom('%H:%M')}}

- sensor:
  - name: "Home Battery Charge End Time"
    unique_id: home_battery_charge_end_time
    icon: mdi:clock-end
    state: >
      {% set start_time = states('octopusagile.home_battery') %}
      {% set end_in = state_attr('octopusagile.home_battery','end_in') %}
      {% set start_in = state_attr('octopusagile.home_battery','start_in') %}
      {% set duration_in_secs = (end_in|float(0) - start_in|float(0))*3600 %}  
      {% set end_time = (as_timestamp(start_time) + duration_in_secs )|timestamp_custom ('%H:%M')%}
        {{ end_time }}

### EV Charge Times ### 
- sensor:
  - name: "EV Charge Start Time"
    unique_id: ev_charge_start_time
    icon: mdi:clock-start
    state: >
      {% set start_time = states('octopusagile.electric_vehicle') %}
        {{ as_timestamp(start_time)|timestamp_custom('%H:%M')}}

- sensor:
  - name: "EV Charge End Time"
    unique_id: ev_charge_end_time
    icon: mdi:clock-end
    state: >
      {% set start_time = states('octopusagile.electric_vehicle') %}
      {% set end_in = state_attr('octopusagile.electric_vehicle','end_in') %}
      {% set start_in = state_attr('octopusagile.electric_vehicle','start_in') %}
      {% set duration_in_secs = (end_in|float(0) - start_in|float(0))*3600 %}  
      {% set end_time = (as_timestamp(start_time) + duration_in_secs )|timestamp_custom ('%H:%M')%}
        {{ end_time }}

  - name: "Estimated Earliest Evening MODBUS Disconnect Times"
    unique_id: estimated_earliest_evening_modbus_disconnect_times
    icon: mdi:clock-start
    state: >
      {% set t1 = states('input_datetime.morning_modbus_disconnect_time') %}
      {% set t2 = '13:54:00' %}
      {% set time_pm_earliest = (as_timestamp(strptime(t1, '%H:%M:%S')) + as_timestamp(strptime(t2, '%H:%M:%S')))|timestamp_custom ('%H:%M') %}
        {{ time_pm_earliest }}
      
  - name: "Estimated Latest Evening MODBUS Disconnect Times"
    unique_id: estimated_latest_evening_modbus_disconnect_times
    icon: mdi:clock-start
    state: >
      {% set t1 = states('input_datetime.morning_modbus_disconnect_time') %}
      {% set t2 = '14:08:00' %}
      {% set time_pm_latest = (as_timestamp(strptime(t1, '%H:%M:%S')) + as_timestamp(strptime(t2, '%H:%M:%S')))|timestamp_custom ('%H:%M') %}
        {{ time_pm_latest }}

  - name: "Estimated Earliest Morning MODBUS Disconnect Times"
    unique_id: estimated_earliest_morning_modbus_disconnect_times
    icon: mdi:clock-start
    state: >
      {% set t1 = states('input_datetime.evening_modbus_disconnect_time')  %}
      {% set t2 = '09:56:00' %}
      {% set time_am_earliest = (as_timestamp(strptime(t1, '%H:%M:%S')) + as_timestamp(strptime(t2, '%H:%M:%S')))|timestamp_custom ('%H:%M') %}
        {{ time_am_earliest }}
      
  - name: "Estimated Latest Morning MODBUS Disconnect Times"
    unique_id: estimated_latest_morning_modbus_disconnect_times
    icon: mdi:clock-start
    state: >
      {% set t1 = states('input_datetime.evening_modbus_disconnect_time')  %}
      {% set t2 = '10:10:00' %}
      {% set time_am_latest = (as_timestamp(strptime(t1, '%H:%M:%S')) + as_timestamp(strptime(t2, '%H:%M:%S')))|timestamp_custom ('%H:%M') %}
        {{ time_am_latest }} 
