 ############################################################################### 
 #   @author         :   Jeffrey Stone                                         #
 #   @date           :   06/10/2020                                            #
 #   @package        :   audio.yaml                                            #
 #   @description    :   Sends audible notifications to the right Alexa        # 
 #                                                                             #
 #   @modified by    :   Dave Forrester (@Daverover66)                         #
 #   @date           :   24/08/2023                                            #
 ###############################################################################
 
 sensor:
  - platform: mqtt
    name: "Room Presence"
    state_topic: "house/presence/current_room"
  - platform: template
    sensors:
      room_audio:
        friendly_name: "Room Audio"
        value_template: >-
      {% set last_alexa_called_seconds = (now() - as_local(states.media_player | rejectattr('object_id','match', '(sky_q|toshiba)') | selectattr('attributes.last_called','eq',True) | map(attribute='last_updated') | first)).seconds %}
  {%- if last_alexa_called_seconds <= 60 %} 
    {{ states.media_player | selectattr('attributes.last_called','eq',True) | map(attribute='entity_id') | first }}
  {% elif expand('group.room_with_alexa_presence') | selectattr('state', 'eq', 'on') | list | count >= 1 %}
    {% set sensor = expand('group.room_with_alexa_presence') | selectattr('state', 'eq', 'on') | sort(attribute='last_changed') | last %}
      {% if is_state('input_boolean.audible_notifications', 'off') %}
        {% if sensor.name == 'Room Occupied Living Room' %}
          living_room
        {% else %}
          kitchen      
        {%- endif %}
      {% else %} 
        {% if sensor.name == 'Room Occupied Main Bedroom' %}
          main_bedroom
        {% elif sensor.name in ('Room Occupied Kitchen' ) %}
          kitchen
        {% elif sensor.name in ('Room Occupied Living Room' ) %}
          living_room
        {% elif sensor.name in ('Room Occupied Dining Room' ) %}
          dining_room
        {% elif sensor.name in ('Room Occupied Guest Bedroom') %}
          guest_bedroom
        {% elif sensor.name in ('Room Occupied Jamies Room') %}
          jamies_room
        {% elif sensor.name in ('Room Occupied Seans Room') %}
          seans_room
        {%- endif %}
    {%- endif %}
      {% elif is_state('media_player.sky_q_main', 'on') %}
         living_room
      {% else %}
        {{ states('sensor.room_presence') }}
      {% endif %}  
